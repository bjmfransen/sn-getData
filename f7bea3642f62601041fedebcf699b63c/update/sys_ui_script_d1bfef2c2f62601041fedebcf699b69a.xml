<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_ui_script">
    <sys_ui_script action="INSERT_OR_UPDATE">
        <active>true</active>
        <description/>
        <global>false</global>
        <name>bjGetData</name>
        <script><![CDATA[(function() {
	top.NSNOW = top.NSNOW || {};

	/**
	 * The provided callback function takes a javascript object as its argument. The callback
	 * called by getXMLAnswer however is provided with a json-string. This function converts that
	 * string and passes it on to the callback function provided by the user
	 * @param {Function} callback - callback function provided by the user, takes javascript object as its argument
	 * @returns {?} - returns whatever is returned by the user provided callback function
	 */
	function generateCallback(callback){
		// response is the json string returned by the ajax call
		return function (response){
			// convert json string to object and provide it as an argument to the callback function
			var o = JSON.parse(response);
			return callback(o);
		}
	}

	/**
	 * Client encapsulation of ajax call retrieving record data from the server
	 * @param {string} table - name of the table to be queried
	 * @param {string} query - query to be performed
	 * @param {string[]} fields - field names to be retrieved
	 * @param {number} max - maximum number of records
	 * @param {Function} callback - this function will process the response, which is an array of records. 
	 *	Each record is represented by object that have the requested field name as key, and store that fields value/display value
	 *  as keys value and display respectively. sys_id will always be included. Sample response:
	 * [
	 *     {
	 *         "owner": {
	 *             "value": "572a9b801b24e810217080f4464bcb8c",
	 *             "display": "Homer Simpson"
	 *         },
	 *         "sys_id ":{
	 *         	"value": "49a3bc191b41103d6fceb186e4bcb28",
	 *         	"display":"49a3bc191b411030d6fceb186e4bcb28"
	 *         }
	 *     }
	 * ]
	 *
	 * @returns {} - return value of the callback
	 *
	 * Example:
	 *
	 *	getData('sys_user', 'sys_id=123abc', ['first_name', 'last_name', 'email', 'manager'], 1, function(response){
	 *		console.log(response[0].first_name.value, response[0].manager.display)
	 *  })
	 */
	top.NSNOW.getRecords = function(table, query, fields, max, callback){
		var gaDUA = new GlideAjax('bjDataUtilsAjax');
		gaDUA.addParam('sysparm_name', 'getRecords');
		gaDUA.addParam('table', table);
		gaDUA.addParam('query', query);
		gaDUA.addParam('fields', fields.join(','));
		gaDUA.addParam('max', max);

		gaDUA.getXMLAnswer(generateCallback(callback));
	}

/**
 * Retrieves record data based on a catalog reference. The catalog item, name of the reference field
 * and its value are used to determine the record, returnFields tells it which field values to return.
 *
 * @param {GlideForm} gf - reference to the current glide form
 * @param {string} field - catalog variable name; this references the record to be retrieved
 * @param {string[]} returnFields - field names to be retrieved
 * @param {Function} callback - this function will process the response, which is the references record. 
 * @returns {} - return value of the callback
 */
	top.NSNOW.getCatalogReference = function(gf, field, returnFields, callback){
		var gaDUA = new GlideAjax('bjDataUtilsAjax');
		gaDUA.addParam('sysparm_name', 'getCatalogReference');
		gaDUA.addParam('cat_item', gf.getSysId());
		gaDUA.addParam('field', field);
		gaDUA.addParam('value', gf.getValue(field));
		gaDUA.addParam('fields', returnFields.join(','));

		gaDUA.getXMLAnswer(generateCallback(callback));
	}

/**
 * Sets values on g_form. field is the reference field that determines which record is referenced.
 * fieldMapping is an object. Each key/value pair is a variable name (key) that will be filled 
 * with the value of the record's field (value) using g_form.setValue
 * @param {GlideForm} gf - reference to the current glide form
 * @param {string} field - catalog variable name; this references the record to be retrieved
 * @param {fieldMapping{}} - maps variable names to record fields. key: variable name, value: field name in the record
 * @returns {} - return value of the callback
 */
	top.NSNOW.setFormValues = function(gf, field, fieldMapping, checkClassName){
		var catalogVariables = [];
		var fieldNames = [];
		var key;

		for (key in fieldMapping){
			catalogVariables.push(key);
			fieldNames.push(fieldMapping[key]);
		}

		var gaDUA = new GlideAjax('bjDataUtilsAjax');
		gaDUA.addParam('sysparm_name', 'getCatalogReference');
		gaDUA.addParam('cat_item', gf.getSysId());
		gaDUA.addParam('field', field);
		gaDUA.addParam('value', gf.getValue(field));
		gaDUA.addParam('fields', fieldNames.join(','));
		if (checkClassName){
			gaDUA.addParam('checkClassName', true);
		}
		
		gaDUA.getXMLAnswer(generateCallback(function(response){
			var variableName;

			for (variableName in fieldMapping){
				var fieldName = fieldMapping[variableName];
				gf.setValue(variableName, response[fieldName].value, response[fieldName].display);
			}
		}));
	}
})();]]></script>
        <script_name/>
        <sys_class_name>sys_ui_script</sys_class_name>
        <sys_created_by>bert-jan.fransen</sys_created_by>
        <sys_created_on>2021-02-22 16:43:24</sys_created_on>
        <sys_id>d1bfef2c2f62601041fedebcf699b69a</sys_id>
        <sys_mod_count>1</sys_mod_count>
        <sys_name>bjGetData</sys_name>
        <sys_package display_value="GetData" source="f7bea3642f62601041fedebcf699b63c">f7bea3642f62601041fedebcf699b63c</sys_package>
        <sys_policy/>
        <sys_scope display_value="GetData">f7bea3642f62601041fedebcf699b63c</sys_scope>
        <sys_update_name>sys_ui_script_d1bfef2c2f62601041fedebcf699b69a</sys_update_name>
        <sys_updated_by>bert-jan.fransen</sys_updated_by>
        <sys_updated_on>2021-02-22 16:43:38</sys_updated_on>
        <ui_type>10</ui_type>
        <use_scoped_format>false</use_scoped_format>
    </sys_ui_script>
</record_update>
