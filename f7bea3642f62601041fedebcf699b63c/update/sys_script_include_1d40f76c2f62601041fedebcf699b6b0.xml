<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>public</access>
        <active>true</active>
        <api_name>global.bjDataUtilsAjax</api_name>
        <caller_access/>
        <client_callable>true</client_callable>
        <description/>
        <name>bjDataUtilsAjax</name>
        <script><![CDATA[var bjDataUtilsAjax = Class.create();
bjDataUtilsAjax.prototype = Object.extendsObject(bjAbstractAjaxProcessor, {
    getRecords: function() {
        // retrieves a number of records and returns them.
        var table = this.getTypedParameter('table', 'string');
        var query = this.getTypedParameter('query', 'string');
        var fields = this.getTypedParameter('fields', 'array');
        var max = this.getTypedParameter('max', 'number', -1);

        if (table !== '' && query !== '' && fields.length > 0) {
            var data = new bjDataUtils().getData(table, query, fields, max);

            return JSON.stringify(data);
        }
    },

    getCatalogReference: function() {
		gs.info('bjDataUtilsAjax#getCatalogReference')
        var catItemId = this.getTypedParameter('cat_item', 'string'); // source table
        var field = this.getTypedParameter('field', 'string'); // reference field
        var value = this.getTypedParameter('value', 'string'); // reference field's value
        var fields = this.getTypedParameter('fields', 'array'); // fields in the referenced records that need to be retrieved

        //find the variable record and use it to retrieve the referenced table
        var refTable = this.getReferenceTable(catItemId, field);

        if (refTable !== '' && field !== '' && fields.length > 0) {
			var record = new bjDataUtils().getRecord(refTable, value, fields);
        }

        var result = JSON.stringify(record);
		gs.info(result)
		return result;
    },
	
	getReferenceTable: function(catItemId, variableName){
        // finds the reference table referred to by variableName
        var result = '';
        var gr = new GlideRecord('item_option_new');
        var variableSets = this.getVariableSets(catItemId);
        gr.addQuery('cat_item', catItemId).addOrCondition('variable_set', 'IN', variableSets);
        gr.addQuery('name', variableName);
        gr.setLimit(1);
        gr.query();

        if (gr.next()) {
            var result = gr.getValue('reference');
        }
    
        return result;
    },
    
    getVariableSets: function(catItemId){
        // returns array with the sys_ids of the variable sets related to the catalog item
        var result = [];
        var grIoSetItem = new GlideRecord('io_set_item');
        grIoSetItem.addQuery('sc_cat_item', catItemId);
        grIoSetItem.query();

        while (grIoSetItem.next()){
            result.push(grIoSetItem.getValue('variable_set'));
        }
        
        return result;
    },

    type: 'bjDataUtilsAjax'
});]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>bert-jan.fransen</sys_created_by>
        <sys_created_on>2021-02-22 16:45:30</sys_created_on>
        <sys_id>1d40f76c2f62601041fedebcf699b6b0</sys_id>
        <sys_mod_count>19</sys_mod_count>
        <sys_name>bjDataUtilsAjax</sys_name>
        <sys_package display_value="GetData" source="f7bea3642f62601041fedebcf699b63c">f7bea3642f62601041fedebcf699b63c</sys_package>
        <sys_policy/>
        <sys_scope display_value="GetData">f7bea3642f62601041fedebcf699b63c</sys_scope>
        <sys_update_name>sys_script_include_1d40f76c2f62601041fedebcf699b6b0</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2021-02-26 14:50:28</sys_updated_on>
    </sys_script_include>
</record_update>
